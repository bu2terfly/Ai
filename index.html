<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispur College AI Assistant - Live Test</title>
    <style>
        /* CSS for a modern, minimal, trackable UI */
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --background-dark: #1e1e1e;
            --text-light: #f5f5f5;
            --card-dark: #2a2a2a;
            --border-color: #444;
            --ai-bubble: #343a40;
            --user-bubble: var(--primary);
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .chat-container {
            width: 100%;
            max-width: 700px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background-color: var(--card-dark);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .header {
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }
        .chat-display {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble);
            color: var(--text-light);
            border-bottom-left-radius: 4px;
        }
        /* Status and Monitoring Styles */
        .status-message {
            font-size: 0.8em;
            text-align: center;
            margin-top: -10px;
        }
        .status-message.cache-hit {
            color: #28a745; /* Green for success */
        }
        .status-message.api-call {
            color: #ffc107; /* Yellow for usage */
        }
        .input-area {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
        }
        #userInput {
            flex-grow: 1;
            padding: 12px;
            border-radius: 25px;
            background-color: var(--background-dark);
            color: var(--text-light);
            margin-right: 10px;
            outline: none;
            border: 1px solid var(--border-color);
        }
        #sendButton {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #sendButton:hover {
            background-color: #0056b3;
        }
        .loading::after {
            content: '...';
            display: inline-block;
            animation: loading-dots 1.5s infinite;
        }
        @keyframes loading-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        /* Usage Monitor Panel */
        .monitor-panel {
            background-color: var(--background-dark);
            padding: 10px 20px;
            font-size: 0.85em;
            border-top: 2px solid var(--primary);
            display: flex;
            justify-content: space-around;
        }
        .monitor-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
        }
        .monitor-label {
            color: var(--secondary);
            font-weight: normal;
        }
        .monitor-value {
            font-weight: bold;
            color: var(--text-light);
        }
        .monitor-value.cost {
            color: #dc3545; /* Red for cost */
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            Dispur College AI Assistant üéì
        </div>
        <div class="chat-display" id="chatDisplay">
            <div class="message ai-message">
                Hello! I am your College Assistant. Try asking about **attendance, library, or fees** to test caching and token usage!
            </div>
        </div>
        
        <div class="monitor-panel">
            <div class="monitor-item">
                <span class="monitor-label">Requests Per Day (RPD)</span>
                <span class="monitor-value" id="monitorRPD">0</span>
            </div>
            <div class="monitor-item">
                <span class="monitor-label">Total Tokens</span>
                <span class="monitor-value" id="monitorTokens">0</span>
            </div>
            <div class="monitor-item">
                <span class="monitor-label">Last Input/Output</span>
                <span class="monitor-value" id="monitorIO">0 / 0</span>
            </div>
            <div class="monitor-item">
                <span class="monitor-label">Cumulative Est. Cost</span>
                <span class="monitor-value cost" id="monitorCost">$0.00000</span>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Ask a question..." autofocus>
            <button id="sendButton">‚û§</button>
        </div>
    </div>

    <script>
        // ************************************************
        // ******* PLACE YOUR API KEY HERE ****************
        // ************************************************
        // WARNING: This key is visible to anyone on GitHub Pages. ONLY use this for testing!
        const GEMINI_API_KEY = "AIzaSyBqgrroGtY9YNz5TwrG0Tj6OHaAGVhAEGU"; 
        
        // --- DUMMY KNOWLEDGE BASE (Simulated RAG Content) ---
        const DUMMY_COLLEGE_INFO = {
            "library": "Dispur college's main library is located behind the cafeteria, on the ground floor of the Principle's office building.",
            "fees": "Semester fees are ‚Çπ12,500 and must be paid by the 10th of every month.",
            "exams": "The sessional exam dates are October 15th-20th. Key topics are Chapter 3 and 5."
        };

        // --- PRODUCTION LOGIC & MONITORING OBJECT ---
        const FLASH_LITE_COST_PER_MILLION_INPUT = 0.10;
        const FLASH_LITE_COST_PER_MILLION_OUTPUT = 0.40;
        
        const tokenMonitor = {
            rpdCount: 0,
            totalTokens: 0,
            cumulativeCost: 0,
            updateUI: function(inputTokens, outputTokens, isCached) {
                // Only track RPD and cumulative cost if tokens were used (i.e., not cached)
                if (!isCached) {
                    this.rpdCount += 1;
                    const totalTokens = inputTokens + outputTokens;
                    this.totalTokens += totalTokens;
                    
                    const inputCost = inputTokens * (FLASH_LITE_COST_PER_MILLION_INPUT / 1000000);
                    const outputCost = outputTokens * (FLASH_LITE_COST_PER_MILLION_OUTPUT / 1000000);
                    this.cumulativeCost += inputCost + outputCost;
                }
                
                // Update UI elements regardless of cache status
                document.getElementById('monitorRPD').textContent = this.rpdCount;
                document.getElementById('monitorTokens').textContent = this.totalTokens;
                document.getElementById('monitorIO').textContent = `${inputTokens} / ${outputTokens}`;
                document.getElementById('monitorCost').textContent = `$${this.cumulativeCost.toFixed(5)}`;
            }
        };

        // --- SIMULATED VERCEL SERVERLESS FUNCTION (Backend Logic) ---
        function getSimulatedAPIResponse(message) {
            const lowerMsg = message.toLowerCase();
            let aiResponse = "";
            let tokenData = { input: 0, output: 0, cached: false };

            // 1. Caching Check (Simulated RAG Check)
            if (lowerMsg.includes('library') || lowerMsg.includes('located') || lowerMsg.includes('fees') || lowerMsg.includes('exam')) {
                let context = "";
                if (lowerMsg.includes('library')) context = DUMMY_COLLEGE_INFO.library;
                else if (lowerMsg.includes('fees')) context = DUMMY_COLLEGE_INFO.fees;
                else if (lowerMsg.includes('exam')) context = DUMMY_COLLEGE_INFO.exams;
                
                if (context) {
                    aiResponse = context;
                    tokenData.cached = true;
                }
            }
            
            // 2. Function Calling Check (Attendance/Dynamic)
            if (lowerMsg.includes('attendance') || lowerMsg.includes('skip') || lowerMsg.includes('percentage')) {
                // This simulates a Cache MISS and a successful API call.
                const current = Math.floor(Math.random() * (90 - 70) + 70); 
                const projection = Math.floor(current * 0.95); 
                
                // Strict, point-to-point response style
                aiResponse = `Your Current overall is **${current}%**. If you skip 3 days then your overall will be **${projection}%** for all subject combined.`;
                
                // Token usage for a successful Function Call (Our calculated values)
                tokenData.input = 143; 
                tokenData.output = 65;
                tokenData.cached = false;
            }

            // 3. Fallback/Grounding Failure Check
            if (!tokenData.cached && tokenData.input === 0) {
                 // Question was not static or dynamic (e.g., "what is the weather?"). 
                 aiResponse = "I can only answer questions about Dispur College attendance or policies. Please rephrase your question.";
                 tokenData.input = 80; // Cost of the prompt/system instructions
                 tokenData.output = 30; // Cost of the short rejection
                 tokenData.cached = false;
            }

            return { text: aiResponse, tokens: tokenData };
        }

        const chatDisplay = document.getElementById('chatDisplay');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        
        function appendMessage(sender, text, status) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = text; 
            chatDisplay.appendChild(messageDiv);
            
            if (status) {
                const statusDiv = document.createElement('div');
                statusDiv.classList.add('status-message', status.cached ? 'cache-hit' : 'api-call');
                statusDiv.textContent = status.cached ? "‚ö°Ô∏è CACHE HIT: Cost $0.00" : `üí∞ API CALL: Tokens used: ${status.input}/${status.output}`;
                chatDisplay.appendChild(statusDiv);
            }
            
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return messageDiv;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage('user', message);
            userInput.value = '';
            sendButton.disabled = true;

            const simResult = getSimulatedAPIResponse(message);
            const tokenData = simResult.tokens;

            if (!tokenData.cached) {
                // Simulate network latency for API calls
                const loadingMessage = appendMessage('ai', '<span class="loading">Processing Request...</span>');
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                loadingMessage.remove(); 
            }

            // Final AI response is displayed
            appendMessage('ai', simResult.text, tokenData);

            // Update the UI monitor
            tokenMonitor.updateUI(tokenData.input, tokenData.output, tokenData.cached);
            
            sendButton.disabled = false;
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Initialize the monitor UI
        tokenMonitor.updateUI(0, 0, true);

    </script>
</body>
</html>
