<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College AI Assistant - Token Tracker</title>
    <style>
        /* Modern Minimal CSS (Same as before, with added monitor styling) */
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --background-dark: #1e1e1e;
            --text-light: #f5f5f5;
            --card-dark: #2a2a2a;
            --border-color: #444;
            --ai-bubble: #343a40;
            --user-bubble: var(--primary);
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .chat-container {
            width: 100%;
            max-width: 700px;
            height: 90vh; /* Increased height to accommodate the monitor */
            display: flex;
            flex-direction: column;
            background-color: var(--card-dark);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .header {
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }
        .chat-display {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--card-dark);
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble);
            color: var(--text-light);
            border-bottom-left-radius: 4px;
        }
        .input-area {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
        }
        #userInput {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background-color: var(--background-dark);
            color: var(--text-light);
            font-size: 1em;
            margin-right: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        #userInput:focus {
            border-color: var(--primary);
        }
        #sendButton {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        #sendButton:hover {
            background-color: #0056b3;
        }
        #sendButton:active {
            transform: scale(0.95);
        }
        .loading::after {
            content: '...';
            display: inline-block;
            animation: loading-dots 1.5s infinite;
        }
        @keyframes loading-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        /* New Styles for Usage Monitor */
        .monitor-panel {
            background-color: var(--background-dark);
            padding: 10px 20px;
            font-size: 0.85em;
            border-top: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
        }
        .monitor-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .monitor-label {
            color: var(--secondary);
            font-weight: normal;
        }
        .monitor-value {
            font-weight: bold;
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            Dispur College AI Assistant ðŸŽ“
        </div>
        <div class="chat-display" id="chatDisplay">
            <div class="message ai-message">
                Hello! I am your College Assistant. Ask me about **attendance** or **college info** (like the library or principal).
            </div>
        </div>
        
        <div class="monitor-panel">
            <div class="monitor-item">
                <span class="monitor-label">Requests Per Day (RPD)</span>
                <span class="monitor-value" id="monitorRPD">0</span>
            </div>
            <div class="monitor-item">
                <span class="monitor-label">Total Tokens</span>
                <span class="monitor-value" id="monitorTokens">0</span>
            </div>
            <div class="monitor-item">
                <span class="monitor-label">Last Input Tokens</span>
                <span class="monitor-value" id="monitorInput">0</span>
            </div>
            <div class="monitor-item">
                <span class="monitor-label">Last Output Tokens</span>
                <span class="monitor-value" id="monitorOutput">0</span>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Ask a question about college or your attendance..." autofocus>
            <button id="sendButton">âž¤</button>
        </div>
    </div>

    <script>
        // *** PLACEHOLDER: 1. Replace with your actual Gemini API Key ***
        const GEMINI_API_KEY = "AIzaSyBqgrroGtY9YNz5TwrG0Tj6OHaAGVhAEGU"; 
        const GEMINI_MODEL = "gemini-2.5-flash"
        
        // --- DUMMY KNOWLEDGE BASE (RAG Context Simulation) ---
        const DUMMY_COLLEGE_INFO = {
            "library": "Dispur college's library is located behind the cafeteria on the ground floor of the Principle's office building.",
            "principal": "The principal's name is Dr. S. K. Sharma, and his joining date was August 15, 2018.",
            "exams": "The sessional exam dates are October 15th-20th. Key topics are Chapter 3 and 5.",
            "policy": "The college attendance policy states that students must maintain a minimum of 75% attendance to sit for the final exam."
        };

        // --- TOKEN MONITORING OBJECT (Replaces console logging) ---
        const tokenMonitor = {
            rpdCount: 0,
            totalTokens: 0,
            updateUI: function(inputTokens, outputTokens) {
                // RPD only increments on a simulated API call (Cache Miss)
                if (inputTokens > 0) { 
                    this.rpdCount += 1;
                    this.totalTokens += inputTokens + outputTokens;
                }
                
                // Update the UI elements
                document.getElementById('monitorRPD').textContent = this.rpdCount;
                document.getElementById('monitorTokens').textContent = this.totalTokens;
                document.getElementById('monitorInput').textContent = inputTokens;
                document.getElementById('monitorOutput').textContent = outputTokens;
            }
        };

        const chatDisplay = document.getElementById('chatDisplay');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = text; 
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
            return messageDiv;
        }

        function getSimulatedResponse(message) {
            const lowerMsg = message.toLowerCase();
            
            // --- Caching/Static Questions (Simulated Cache Hit) ---
            if (lowerMsg.includes('library') || lowerMsg.includes('located') || lowerMsg.includes('room')) {
                // If this were a real app, the server checks cache, finds it, and sends the answer.
                // TOKEN COST: 0 (Cache Hit)
                return { 
                    text: DUMMY_COLLEGE_INFO.library, 
                    tokens: { input: 0, output: 0, cached: true } 
                };
            }
            if (lowerMsg.includes('principal') || lowerMsg.includes('date')) {
                 return { 
                    text: DUMMY_COLLEGE_INFO.principal, 
                    tokens: { input: 0, output: 0, cached: true } 
                };
            }
            
            // --- Attendance/Dynamic Questions (Simulated API Call/Cache Miss) ---
            if (lowerMsg.includes('attendance') || lowerMsg.includes('skip') || lowerMsg.includes('percentage')) {
                // Simulate a successful Function Call (Cost based on our previous calculation)
                const current = Math.floor(Math.random() * (90 - 70) + 70); // Random initial percentage
                const projection = Math.floor(current * 0.95); // Simulate a drop
                
                return {
                    text: `Your Current overall is **${current}%**. If you skip 3 days then your overall will be **${projection}%** for all subject combined.`,
                    tokens: { input: 143, output: 65, cached: false } // Our calculated token usage
                };
            }

            // --- General Fallback Question (Simulated API Call/Cache Miss) ---
            return {
                text: "I can answer questions about attendance, the library, or the principal. Please try asking one of those!",
                tokens: { input: 80, output: 40, cached: false } 
            };
        }


        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // 1. Display user message
            appendMessage('user', message);
            userInput.value = '';
            
            // 2. Get simulated response and token data
            const simResult = getSimulatedResponse(message);
            const tokenData = simResult.tokens;

            // 3. Display loading message only if an API call is simulated
            let loadingMessage;
            if (!tokenData.cached) {
                loadingMessage = appendMessage('ai', '<span class="loading">Thinking...</span>');
                sendButton.disabled = true;
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network latency
            } else {
                 // For cached hits, display instantly and mark as cached
                const cacheHitMessage = appendMessage('ai', 'âš¡ï¸ **Cache Hit!** Finding info instantly...');
                await new Promise(resolve => setTimeout(resolve, 500)); 
                cacheHitMessage.remove(); // Remove the cache hit message after a moment
            }


            // 4. Update the loading message or append the instant answer
            if (loadingMessage) {
                loadingMessage.innerHTML = simResult.text;
            } else {
                appendMessage('ai', simResult.text);
            }

            // 5. Update the UI monitor with the usage data
            tokenMonitor.updateUI(tokenData.input, tokenData.output);
            
            sendButton.disabled = false;
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Initialize the monitor UI
        tokenMonitor.updateUI(0, 0);

    </script>
</body>
</html>
