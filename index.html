<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attenza Notifications</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-app: #FDFBF7;
            --bg-surface: #FFFFFF;
            --text-dark: #111827;
            --text-medium: #6B7280;
            --accent-info: #0EA5E9;
            --accent-alert: #EF4444;
            --accent-tip: #10B981;
        }

        body {
            font-family: 'Inter Tight', sans-serif;
            background-color: var(--bg-app);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
        }

        .header {
            padding: 32px 24px 16px 24px;
            background: var(--bg-app);
        }

        .header h1 {
            font-size: 26px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .feed-container {
            max-width: 640px;
            margin: 0 auto;
            background: var(--bg-surface);
            border-top: 1px solid rgba(0,0,0,0.04);
            min-height: 300px;
        }

        /* Notification Item */
        .notif-item {
            padding: 20px 24px;
            border-bottom: 1px solid #F3F4F6;
            display: flex;
            gap: 12px;
            position: relative;
            background: var(--bg-surface);
            opacity: 0;
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn { to { opacity: 1; } }

        .accent-bar {
            width: 4px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .item-body { flex: 1; }

        .item-header-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .svg-icon { width: 16px; height: 16px; display:flex; }
        .svg-icon svg { width: 100%; height: 100%; }

        .item-title-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 4px;
        }

        .item-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            color: var(--text-dark);
            line-height: 1.3;
        }

        .new-badge {
            background: var(--accent-alert);
            color: white;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .item-message {
            font-size: 14px;
            color: var(--text-medium);
            line-height: 1.5;
            margin: 0 0 12px 0;
        }

        .item-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        /* Type Colors */
        .type-info .accent-bar { background-color: var(--accent-info); }
        .type-info .item-header-row { color: var(--accent-info); }
        .type-info .item-action-btn { background: #E0F2FE; color: var(--accent-info); }
        
        .type-alert .accent-bar { background-color: var(--accent-alert); }
        .type-alert .item-header-row { color: var(--accent-alert); }
        .type-alert .item-action-btn { background: #FEE2E2; color: var(--accent-alert); }

        .type-tip .accent-bar { background-color: var(--accent-tip); }
        .type-tip .item-header-row { color: var(--accent-tip); }
        .type-tip .item-action-btn { background: #D1FAE5; color: var(--accent-tip); }

        /* Loading */
        .state-msg { padding: 60px 20px; text-align: center; color: var(--text-medium); }
    </style>
</head>
<body>

    <div class="header">
        <h1>Notifications</h1>
    </div>

    <div class="feed-container" id="feed">
        <div class="state-msg">
            <p>Checking updates...</p>
        </div>
    </div>

    <div style="display:none;">
        <div id="icon-info"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg></div>
        <div id="icon-alert"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg></div>
        <div id="icon-tip"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg></div>
    </div>

    <script>
        // CONFIG
        const SHEET_ID = '1YWUh0uCyc6IaCuFTBUPqsGBq9yt94n8HZ70DSNdHw8o'; 
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        
        const feedContainer = document.getElementById('feed');
        
        // Grab Icon HTML
        const iconInfo = document.getElementById('icon-info').innerHTML;
        const iconAlert = document.getElementById('icon-alert').innerHTML;
        const iconTip = document.getElementById('icon-tip').innerHTML;

        async function fetchNotifications() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error('Failed to connect');
                
                const text = await response.text();
                // Strip the Google Wrapper
                const jsonText = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonText);
                
                const rawRows = json.table.rows;
                
                // If sheet is empty
                if (!rawRows || rawRows.length === 0) {
                     feedContainer.innerHTML = '<div class="state-msg">No updates right now.</div>';
                     return;
                }

                // Clean data
                const notifications = rawRows.map(row => ({
                    title: row.c[0]?.v || "Update",
                    message: row.c[1]?.v || "",
                    type: row.c[2]?.v?.toLowerCase() || "info",
                    active: row.c[3]?.v || false,
                    priority: row.c[4]?.v || 0,
                    expiryDate: row.c[5]?.v ? new Date(row.c[5].f || row.c[5].v) : null,
                    linkUrl: row.c[6]?.v || null,
                    linkText: row.c[7]?.v || "Open"
                }));

                renderFeed(notifications);

            } catch (error) {
                console.error(error);
                feedContainer.innerHTML = '<div class="state-msg">Unable to load feed. Check connection.</div>';
            }
        }

        function renderFeed(data) {
            const today = new Date();
            today.setHours(0,0,0,0);

            // Filter
            const activeData = data.filter(item => {
                if (!item.active) return false;
                if (item.expiryDate && item.expiryDate < today) return false;
                return true;
            });

            if (activeData.length === 0) {
                feedContainer.innerHTML = '<div class="state-msg">All caught up! No new notifications.</div>';
                return;
            }

            // Sort
            activeData.sort((a, b) => b.priority - a.priority);

            // Render
            feedContainer.innerHTML = activeData.map((item, index) => {
                // Select Icon
                let useIcon = iconInfo;
                if(item.type === 'alert') useIcon = iconAlert;
                if(item.type === 'tip') useIcon = iconTip;

                // FIX: Variable name is now correct (no space)
                const newBadge = item.priority > 5 ? '<span class="new-badge">NEW</span>' : '';

                const actionBtn = item.linkUrl 
                    ? `<a href="${item.linkUrl}" target="_blank" class="item-action-btn">
                         ${item.linkText} <span>â†’</span>
                       </a>` 
                    : '';

                // Add animation delay
                const delay = `animation-delay: ${index * 0.1}s`;

                return `
                <div class="notif-item type-${item.type}" style="${delay}">
                    <div class="accent-bar"></div>
                    <div class="item-body">
                        <div class="item-header-row">
                            <div class="svg-icon">${useIcon}</div>
                            <span>${item.type}</span>
                        </div>
                        
                        <div class="item-title-row">
                            <h3 class="item-title">${item.title}</h3>
                            ${newBadge}
                        </div>

                        <p class="item-message">${item.message}</p>
                        ${actionBtn}
                    </div>
                </div>
                `;
            }).join('');
        }

        fetchNotifications();
    </script>
</body>
</html>
